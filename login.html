<!DOCTYPE html>
<html>
	<head>
		<meta charset="utf-8">
		<title>平安校园管理平台</title>
		<link href="./css/denglu.css" rel="stylesheet">
		<link rel="shortcut icon" href="./image/favicon.ico" type="image/x-icon" />
		<link rel="stylesheet" href="./js/plugins/layer/skin/layer.css" id="layui_layer_skinlayercss" style="">
		<link rel="stylesheet" href="./js/plugins/layer/skin/layer.ext.css" id="layui_layer_skinlayerextcss" style="">
		<link rel="stylesheet" href="./js/plugins/layer/skin/moon/style.css" id="layui_layer_skinmoonstylecss" style="">
		<style>
			.wz .bg3 div {
				width: 25px;
			}
			.wz .denglu {
				margin-top: 148px;
			}
		</style>
	</head>
	<body>
		<div class="denglubg">
			<div class="wz">
				<div class="denglu">
					<div class="bg1">
						<input type="text" id="usename" name="usename" placeholder="工号/身份证号/手机号">
					</div>
					<div class="bg2">
						<input type="password" id="password" name="password" placeholder="请输入密码">
					</div>
					<div class="bg5">
						<input type="text" id="code_input" placeholder="请输入验证码" autocomplete="off">
						<div id="v_container" style="width: 143px;height: 39px;"></div>	
					</div>
					<div class="bg3" style=" clear: both;">
						<div>
							<input type="checkbox" id="rmbUser">
						</div>
						<span>记住密码</span>	
					</div>
					<div class="bg4">
						<input type="button" class="tijiao" id="submit" value="" >
					</div>
				</div>
			</div>
			<div class="font">技术支持单位：成都上云旗信息技术有限公司 </div>
		</div>
		<script src="./js/jquery.min.js?v=2.1.4"></script>
		<script src="./js/jquery.cookie.js"></script>
		<script src="./js/gVerify.js"></script>
		<script src="./js/common.js"></script>
		<script src="./js/aes-min.js"></script>
		<script src="./js/page/login.js"></script>
		<script src="./js/plugins/layer/layer.min.js"></script>
		<script>
			$(document).ready(function() {
				if(getUrlParam("hao") && getUrlParam("son")){
					logindandian()
				}
			})
			
			 function logindandian(){
			 	var param = {
			 		"username": aesDecode(getUrlParam("hao")) ,
			 		"password": aesDecode(getUrlParam("son")),
			 	};
			 	$.ajax({
			 		type: "POST",
			 		async: false,
			 		url: api_auth + "/auth/login",
			 		contentType: "application/json",
			 		dataType: "json",
			 		data: JSON.stringify(param),
			 		success: function(data) {
			 			if (data.result_state == "0") {
			 				if (!$.isEmptyObject(data.result)) {
			 					saveUserInfo();
			 					if (window.localStorage) {
			 						var sessionStorage = window.sessionStorage;
			 						let token = data.result.token;
			 						let headerName = data.result.headerName;
			 						sessionStorage.setItem("username_zhzz_headerName", headerName);
			 						sessionStorage.setItem("username_zhzz_token", token);
			 						userUserInfoAll();
			 					} else {
			 						layer.alert("请用新版本的浏览器", { icon: 2, title: '提示' })
			 						$("#submit").removeAttr("disabled");
			 						return;
			 					}
			 				} else {
			 					layer.alert("登录失败", { icon: 2, title: '提示' })
			 					$("#submit").removeAttr("disabled");
			 					return;
			 				}
			 			} else {
			 	
			 				verifyCode.refresh(); //生成验证码
			 	
			 				if (data.result_msg == "登录失败：无效令牌！") {
			 					document.location.reload()
			 					layer.alert("登录失效，请刷新页面后重试", { icon: 2, title: '提示' })
			 	
			 				} else if (data.result_msg == "没有找到相关用户信息") {
			 					layer.alert("用户名或者密码错误，请重新输入！", { icon: 2, title: '提示' })
			 					$("#submit").removeAttr("disabled");
			 					return;
			 				} {
			 					alert(data.result_msg);
			 				}
			 	
			 				$("#submit").removeAttr("disabled");
			 				return;
			 	
			 			}
			 		},
			 		error:function(data){
			 			console.log(data.responseJSON.result_msg)
			 			layer.alert(data.responseJSON.result_msg, { icon: 0, title: '警告' },function(){
			 				document.location.reload();
			 			})
			 		},
			 		beforeSend: function(request) {
			 			request.setRequestHeader("loginToken", token);
			 			layer.load();
			 		},
			 		complete: function() {
			 			layer.closeAll('loading');
			 		},
			 	});
			}
		</script>
	</body>
</html>